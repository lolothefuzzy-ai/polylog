#include "main_loop.h"\n#include <algorithm>\n\nnamespace polylog::engine {\n\nMainLoop::MainLoop(const FrameTimingConfig& config) : config_(config) {}\n\nvoid MainLoop::Update(float real_dt_s) {\n    sim_steps_this_frame_ = 0;\n    \n    // Legacy variable-dt mode\n    if (!config_.enable_fixed_step) {\n        sim_time_s_ += real_dt_s;\n        interpolation_alpha_ = 1.0f;  // No interpolation in variable mode\n        sim_steps_this_frame_ = 1;\n        return;\n    }\n    \n    // Clamp incoming delta time\n    ClampDeltaTime(real_dt_s);\n    accumulator_s_ += real_dt_s;\n    \n    // Run fixed simulation steps\n    while (accumulator_s_ >= config_.fixed_dt_s) {\n        sim_time_s_ += config_.fixed_dt_s;\n        accumulator_s_ -= config_.fixed_dt_s;\n        sim_steps_this_frame_++;\n    }\n    \n    // Compute interpolation factor for render frame\n    interpolation_alpha_ = accumulator_s_ / config_.fixed_dt_s;\n}\n\nvoid MainLoop::ClampDeltaTime(float& dt) {\n    // Clamp single-frame spike\n    dt = std::min(dt, config_.max_dt_s);\n    \n    // If accumulator would spiral, reset and skip old time\n    if (accumulator_s_ + dt > config_.max_accumulator_s) {\n        accumulator_s_ = config_.max_accumulator_s - config_.fixed_dt_s;\n    }\n}\n\n}  // namespace polylog::engine\n