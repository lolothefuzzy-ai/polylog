name: Storage Regression Tests

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/polylog6/compression/**'
      - 'src/polylog6/storage/**'
      - 'tests/storage/**'
      - 'data/catalogs/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/polylog6/compression/**'
      - 'src/polylog6/storage/**'
      - 'tests/storage/**'
      - 'data/catalogs/**'

jobs:
  storage-tests:
    name: Storage tier regression tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tier: [0, 1, 2, 3]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tier ${{ matrix.tier }} storage tests
        run: |
          python -m pytest tests/storage/test_tier${{ matrix.tier }}_*.py -v

      - name: Run compression benchmarks
        run: |
          python scripts/benchmark_compression.py --tier ${{ matrix.tier }}

  promotion-tests:
    name: Storage promotion tests
    runs-on: ubuntu-latest
    needs: storage-tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tier 3 promotion tests
        run: |
          python -m pytest tests/storage/test_tier3_*.py -v

      - name: Test storage integrity
        run: |
          python scripts/validate_storage_integrity.py